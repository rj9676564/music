.PHONY: help sqlite mysql stop logs clean backup restart build status

# é»˜è®¤ç›®æ ‡
help:
	@echo "Molten Music - Docker ç®¡ç†å‘½ä»¤"
	@echo ""
	@echo "ä½¿ç”¨æ–¹æ³•:"
	@echo "  make sqlite       - å¯åŠ¨ SQLite ç‰ˆæœ¬ï¼ˆå¼€å‘ç¯å¢ƒï¼‰"
	@echo "  make mysql        - å¯åŠ¨ MySQL ç‰ˆæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰"
	@echo "  make stop         - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make logs         - æŸ¥çœ‹æ—¥å¿—"
	@echo "  make restart      - é‡å¯æœåŠ¡"
	@echo "  make clean        - æ¸…ç†æ‰€æœ‰æ•°æ®å’Œå®¹å™¨"
	@echo "  make backup       - å¤‡ä»½æ•°æ®åº“"
	@echo "  make build        - æ„å»ºé•œåƒ"
	@echo "  make status       - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶:"
	@echo "  .env.sqlite       - SQLite é…ç½®æ¨¡æ¿"
	@echo "  .env.mysql        - MySQL é…ç½®æ¨¡æ¿"
	@echo ""

# å¯åŠ¨ SQLite ç‰ˆæœ¬
sqlite:
	@echo "ğŸš€ å¯åŠ¨ SQLite ç‰ˆæœ¬..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“ åˆ›å»º .env æ–‡ä»¶..."; \
		cp .env.sqlite .env; \
	fi
	@echo "DB_TYPE=sqlite" > .env.tmp
	@grep -v "^DB_TYPE=" .env >> .env.tmp || true
	@mv .env.tmp .env
	docker-compose up -d backend
	@echo "âœ… SQLite ç‰ˆæœ¬å·²å¯åŠ¨"
	@echo "ğŸ“Š è®¿é—®: http://localhost:8080/api/channels"
	@echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—: make logs"

# å¯åŠ¨ MySQL ç‰ˆæœ¬
mysql:
	@echo "ğŸš€ å¯åŠ¨ MySQL ç‰ˆæœ¬..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“ åˆ›å»º .env æ–‡ä»¶..."; \
		cp .env.mysql .env; \
	fi
	@echo "DB_TYPE=mysql" > .env.tmp
	@grep -v "^DB_TYPE=" .env >> .env.tmp || true
	@mv .env.tmp .env
	docker-compose --profile mysql up -d
	@echo "â³ ç­‰å¾… MySQL å°±ç»ª..."
	@sleep 10
	@echo "âœ… MySQL ç‰ˆæœ¬å·²å¯åŠ¨"
	@echo "ğŸ“Š è®¿é—®: http://localhost:8080/api/channels"
	@echo "ğŸ“ æŸ¥çœ‹æ—¥å¿—: make logs"

# åœæ­¢æœåŠ¡
stop:
	@echo "â¹ï¸  åœæ­¢æ‰€æœ‰æœåŠ¡..."
	docker-compose down
	docker-compose --profile mysql down
	@echo "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"

# æŸ¥çœ‹æ—¥å¿—
logs:
	@docker-compose logs -f

# é‡å¯æœåŠ¡
restart:
	@echo "ğŸ”„ é‡å¯æœåŠ¡..."
	@if grep -q "DB_TYPE=mysql" .env 2>/dev/null; then \
		docker-compose --profile mysql restart; \
	else \
		docker-compose restart backend; \
	fi
	@echo "âœ… é‡å¯å®Œæˆ"

# å¤‡ä»½æ•°æ®
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®..."
	@mkdir -p backups
	@if grep -q "DB_TYPE=mysql" .env 2>/dev/null && docker ps | grep -q molten-mysql; then \
		echo "å¤‡ä»½ MySQL æ•°æ®åº“..."; \
		docker exec molten-mysql mysqldump -u molten -pmoltenpass molten_music > backups/molten-$$(date +%Y%m%d-%H%M%S).sql; \
		echo "âœ… MySQL å¤‡ä»½å®Œæˆ"; \
	elif [ -f backend/data/molten.db ]; then \
		echo "å¤‡ä»½ SQLite æ•°æ®åº“..."; \
		cp backend/data/molten.db backups/molten-$$(date +%Y%m%d-%H%M%S).db; \
		echo "âœ… SQLite å¤‡ä»½å®Œæˆ"; \
	else \
		echo "âŒ æ²¡æœ‰æ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶"; \
	fi

# æ¸…ç†æ‰€æœ‰æ•°æ®
clean:
	@echo "âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰æ•°æ®å’Œå®¹å™¨!"
	@read -p "ç¡®è®¤ç»§ç»­? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo "ğŸ§¹ æ¸…ç†ä¸­..."; \
		docker-compose down -v; \
		docker-compose --profile mysql down -v; \
		rm -rf backend/data/molten.db; \
		echo "âœ… æ¸…ç†å®Œæˆ"; \
	else \
		echo "âŒ å·²å–æ¶ˆ"; \
	fi

# æ„å»ºé•œåƒ
build:
	@echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
	docker-compose build --no-cache
	@echo "âœ… æ„å»ºå®Œæˆ"

# æŸ¥çœ‹çŠ¶æ€
status:
	@echo "ğŸ“Š æœåŠ¡çŠ¶æ€:"
	@docker-compose ps
